<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pratinjau Wallpaper Desktop Modern</title>
    <!-- Tailwind Offline CSS (In case of CDN failures) --> 
    <link rel="stylesheet" href="css/all-tailwind-classes-full-min.css">
	<script src="https://cdn.tailwindcss.com"></script>
    <!-- <link href="https://fonts.googleapis.com/css2?family=Segoe+UI&display=swap" rel="stylesheet"> -->
    <style>
        :root {
            /* General Theme */
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --window-bg: #f0f0f0;
            --window-text: #000;
            --window-border: #a0a0a0;
            --control-hover-bg: #e6e6e6;
            --control-close-hover-bg: #e81123;
            --control-close-hover-text: white;
            --taskbar-bg: rgba(245, 245, 245, 0.85);
            --taskbar-text: #000;
            --taskbar-hover-bg: rgba(0, 0, 0, 0.1);
            --backdrop-blur: blur(15px);
            --menu-bg: rgba(255, 255, 255, 0.85);
            /* [MODIFIED] Visualizer Colors for Light Theme (Light on Light) */
            --visualizer-fill: rgba(255, 255, 255, 0.7);
            --visualizer-shadow: rgba(255, 255, 255, 0.5);
            
            /* Variabel baru untuk efek Liquid Glass */
            --c-glass: #f0f0f0;
            --c-light: #ffffff;
            --c-dark: #000000;
            --glass-reflex-dark: 1;
            --glass-reflex-light: 1;
            --saturation: 150%;
        }

        body.dark {
            --window-bg: #2b2b2b;
            --window-text: #f0f0f0;
            --window-border: #555555;
            --control-hover-bg: #3c3c3c;
            --taskbar-bg: rgba(20, 20, 20, 0.85);
            --taskbar-text: white;
            --taskbar-hover-bg: rgba(255, 255, 255, 0.1);
            --menu-bg: rgba(30, 30, 30, 0.75);
            /* [MODIFIED] Visualizer Colors for Dark Theme (Dark on Dark) */
            --visualizer-fill: rgba(0, 0, 0, 0.6);
            --visualizer-shadow: rgba(0, 0, 0, 0.4);

            /* Variabel baru untuk efek Liquid Glass - Mode Gelap */
            --c-glass: #2b2b2b;
            --glass-reflex-dark: 2;
            --glass-reflex-light: 0.3;
        }

        body {
            font-family: var(--font-family);
            overflow: hidden;
        }
        
        #desktop {
            width: 100vw;
            height: 100vh;
            background-image: url('https://placehold.co/1920x1080/3b82f6/ffffff?text=Drag+%26+Drop+Your+Image+Here');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: background-image: 0.3s ease-in-out;
        }

        /* NEW: iframe for live wallpaper */
        #wallpaper-iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            z-index: 0; /* Behind desktop icons */
            display: none; /* Hidden by default */
        }

        .drag-over {
            border: 4px dashed rgba(255, 255, 255, 0.7);
            box-shadow: inset 0 0 100px rgba(0,0,0,0.5);
        }

        .desktop-icon {
            color: white;
            text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.8);
            text-align: center;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            width: 100px;
            opacity: 1;
            transform: translateY(0);
            visibility: visible;
             /* CRITICAL FIX: Only transition background for hover effect. Opacity/transform is handled by animation now. */
            transition: background-color 0.2s ease-out;
        }

        .desktop-icon:hover, .desktop-icon:focus {
            background-color: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            outline: none;
        }
        
        .desktop-icon img, .desktop-icon svg {
            width: 48px;
            height: 48px;
            margin: 0 auto 8px auto;
        }

        /* Universal style for app iframes */
        .app-iframe {
            position: absolute;
            display: none;
            z-index: 1001;
            overflow: hidden;
            border: none;
            background-color: transparent;
        }

        /* Style for Start Menu iframe, optimized size */
        #start-menu-frame {
            position: fixed;
            --start-menu-top: auto;
            --start-menu-left: 0px;
            --start-menu-bottom: auto;
            top: var(--start-menu-top);
            left: var(--start-menu-left);
            bottom: var(--start-menu-bottom);
            border: none;
            background-color: transparent;
            z-index: 499;
            width: 580px; /* Slightly narrower */
            max-width: 95vw;
            height: 640px; /* Reduced height */
            max-height: calc(100vh - 70px); /* Responsive max height with buffer */
            /* Initial hidden state */
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s ease, visibility 0.2s ease, transform 0.2s ease;
            transform: translateY(20px) scale(0.98);
        }

        #start-menu-frame.show {
            visibility: visible;
            opacity: 1;
            transform: translateY(0) scale(1);
        }
        
        #taskbar {
            background-color: var(--taskbar-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            color: var(--taskbar-text);
            position: absolute;
            display: flex;
            align-items: center;
            z-index: 500;
            transition: all 0.3s ease;
        }
        
        .taskbar-icon { padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; display: flex; align-items: center; justify-content: center; }
        .taskbar-icon:hover { background-color: var(--taskbar-hover-bg); }
        .taskbar-icon img, .taskbar-icon svg { height: 24px; width: 24px; }
        .taskbar-bottom { bottom: 0; left: 0; right: 0; height: 48px; flex-direction: row; padding: 0 0.5rem; justify-content: space-between;}
        .taskbar-top { top: 0; left: 0; right: 0; height: 48px; flex-direction: row; padding: 0 0.5rem; justify-content: space-between;}
        .taskbar-left { top: 0; left: 0; bottom: 0; width: 60px; flex-direction: column; padding: 0.5rem 0; justify-content: space-between;}
        .taskbar-right { top: 0; right: 0; bottom: 0; width: 60px; flex-direction: column; padding: 0.5rem 0; justify-content: space-between;}
        #taskbar.island { width: auto; left: 50%; transform: translateX(-50%); right: auto; }
        #taskbar.island.taskbar-bottom { bottom: 0.5rem; }
        #taskbar.island.taskbar-top { top: 0.5rem; }
        #taskbar.island.single { border-radius: 12px; padding: 0.25rem 0.5rem; gap: 0.5rem; }
        #taskbar.island.space-between { width: calc(100% - 1rem); left: 0.5rem; right: 0.5rem; transform: none; justify-content: space-between; }
        #taskbar.island.split { background-color: transparent; backdrop-filter: none; gap: 0.75rem; }
        #taskbar.island.split > div { background-color: var(--taskbar-bg); backdrop-filter: var(--backdrop-blur); -webkit-backdrop-filter: var(--backdrop-blur); border-radius: 12px; display: flex; align-items: center; padding: 0.25rem 0.5rem; height: 40px; }
        
        #context-menu {
            --menu-text: var(--window-text, #212529);
            --menu-hover-bg: var(--taskbar-hover-bg, rgba(0, 0, 0, 0.08));
            --menu-separator: var(--window-border, rgba(0, 0, 0, 0.1));
            --menu-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
            position: absolute; z-index: 2000; display: none; min-width: 250px;
            background-color: var(--menu-bg); backdrop-filter: var(--backdrop-blur) saturate(180%);
            -webkit-backdrop-filter: var(--backdrop-blur) saturate(180%); border-radius: 8px;
            padding: 6px; box-shadow: var(--menu-shadow); border: 1px solid var(--menu-separator);
            font-size: 14px; color: var(--menu-text);
        }
        .context-menu-items { list-style: none; padding: 0; margin: 0; }
        .context-menu-item { display: flex; align-items: center; padding: 8px 12px; cursor: pointer; border-radius: 5px; transition: background-color 0.15s ease; }
        .context-menu-item:hover { background-color: var(--menu-hover-bg); }
        .context-menu-item svg { width: 16px; height: 16px; margin-right: 12px; fill: currentColor; flex-shrink: 0; }
        .context-menu-item .menu-text { flex-grow: 1; }
        .context-menu-item .arrow { margin-left: auto; margin-right: -4px; }
        .context-menu-separator { height: 1px; background-color: var(--menu-separator); margin: 4px 0; }
        
        #visualizer {
            position: absolute; z-index: 498; pointer-events: none; display: none;
            transition: all 0.2s ease-out;
        }

        /* --- Fancy Mode (Liquid Glass) Styles for Taskbar --- */
        body.fancy-mode #taskbar:not(.split),
        body.fancy-mode #taskbar.split > div {
            background-color: color-mix(in srgb, var(--c-glass) 15%, transparent);
            /* MODIFIED: Using the new taskbar-specific filter */
            backdrop-filter: blur(8px) url(#taskbar-liquid-glass-filter) saturate(var(--saturation));
            -webkit-backdrop-filter: blur(8px) url(#taskbar-liquid-glass-filter) saturate(var(--saturation));
            box-shadow: 
                inset 0 0 0 1px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 10%), transparent),
                inset 1.8px 3px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 90%), transparent),
                inset -2px -2px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 80%), transparent),
                inset -3px -8px 1px -6px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 60%), transparent),
                inset -0.3px -1px 4px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 12%), transparent),
                inset -1.5px 2.5px 0px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent),
                inset 0px 3px 4px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent),
                inset 2px -6.5px 1px -4px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent),
                0px 1px 5px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent),
                0px 6px 16px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 8%), transparent);
        }

        /* --- Fancy Mode (Liquid Glass) Styles for Context Menu --- */
        body.fancy-mode #context-menu {
            background-color: color-mix(in srgb, var(--c-glass) 15%, transparent);
            backdrop-filter: blur(8px) url(#liquid-glass-filter) saturate(var(--saturation));
            -webkit-backdrop-filter: blur(8px) url(#liquid-glass-filter) saturate(var(--saturation));
            box-shadow: 
                inset 0 0 0 1px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 10%), transparent),
                inset 1.8px 3px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 90%), transparent),
                inset -2px -2px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 80%), transparent),
                inset -3px -8px 1px -6px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 60%), transparent),
                inset -0.3px -1px 4px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 12%), transparent),
                inset -1.5px 2.5px 0px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent),
                inset 0px 3px 4px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent),
                inset 2px -6.5px 1px -4px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent),
                0px 1px 5px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent),
                0px 6px 16px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 8%), transparent);
            border-color: transparent; /* Hide default border in fancy mode */
        }

        /* In fancy mode, the split container itself should be fully transparent and the default bg removed from the normal taskbar */
        body.fancy-mode #taskbar {
            background-color: transparent;
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
        }

        /* --- NEW: Refresh Icon Animation --- */
        .desktop-icon.hide-for-refresh {
            transition: none !important;
            opacity: 0 !important;
            visibility: hidden;
        }

        .desktop-icon.animate-in {
            visibility: visible;
            animation: slide-fade-in 0.4s ease-out forwards;
        }

        @keyframes slide-fade-in {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="bg-gray-800 select-none">
    
    <!-- Filter SVG for Liquid Glass effect -->
    <div style="position: absolute; width: 0; height: 0; z-index: -1;">
        <svg>
          <!-- Original Filter (for windows) -->
          <filter id="liquid-glass-filter" primitiveUnits="objectBoundingBox">
            <feImage result="map" width="100%" height="100%" x="0" y="0" preserveAspectRatio="none" href="img/svg-filter.jpg"/>    
			<feGaussianBlur in="SourceGraphic" stdDeviation="0.00" result="blur" />
			<feDisplacementMap id="disp" in="blur" in2="map" scale="0.4" xChannelSelector="R" yChannelSelector="G">
			</feDisplacementMap>
          </filter>
          <!-- NEW: Taskbar-specific filter with reduced scale -->
          <filter id="taskbar-liquid-glass-filter" primitiveUnits="objectBoundingBox">
            <feImage result="map" width="120%" height="100%" x="0" y="0" preserveAspectRatio="none" href="img/svg-filter-taskbar.jpg"/>    
			<feGaussianBlur in="SourceGraphic" stdDeviation="0.00" result="blur" />
			<feDisplacementMap id="disp-taskbar" in="blur" in2="map" scale="0.06" xChannelSelector="R" yChannelSelector="G">
			</feDisplacementMap>
          </filter>
        </svg>
    </div>

    <div id="desktop" class="relative">
        
        <!-- NEW: Iframe for live wallpaper, placed here to be under icons -->
        <iframe id="wallpaper-iframe" src="about:blank"></iframe>
        
        <!-- NEW: Invisible layer to intercept clicks for the live wallpaper -->
        <div id="click-interceptor" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; display: none; -webkit-user-drag: none;"></div>

        <!-- MODIFIED: Changed to flex-row for multi-column layout -->
        <div id="desktop-icons" class="absolute top-4 left-4 flex flex-row gap-4 z-10">
            <!-- Column 1 -->
            <div class="flex flex-col gap-2">
                <div class="desktop-icon" tabindex="0"><img src="https://img.icons8.com/fluency/48/000000/desktop.png" alt="This PC"/><span>This PC</span></div>
                <div id="control-panel-icon" class="desktop-icon" tabindex="0"><img src="https://img.icons8.com/fluency/48/000000/control-panel.png" alt="Control Panel"/><span>Control Panel</span></div>
                <div id="music-player-icon" class="desktop-icon" tabindex="0"><img src="https://img.icons8.com/fluency/48/000000/apple-music.png" alt="Music Player"/><span>Music Player</span></div>
                <div class="desktop-icon" tabindex="0"><img src="https://img.icons8.com/fluency/48/000000/recycle-bin.png" alt="Recycle Bin"/><span>Recycle Bin</span></div>
            </div>
            <!-- Column 2 -->
            <div class="flex flex-col gap-2">
                 <!-- MOVED: Live2D Wallpaper icon is now the first in the second column -->
                <div id="live2d-icon" class="desktop-icon" tabindex="0"><img src="https://img.icons8.com/fluency/48/domain.png" alt="Live Wallpaper"/><span>Live Wallpaper</span></div>
            </div>
        </div>

        <iframe id="control-panel-frame" 
                class="app-iframe"
                src="control_panel.html"
                allowtransparency="true"
                style="top: 15%; left: 30%; width: 550px; height: 550px; min-width: 480px; min-height: 400px;">
        </iframe>
        
        <iframe id="start-menu-frame" 
                src="start_menu.html"
                allowtransparency="true">
        </iframe>

        <iframe id="music-player-frame" 
                class="app-iframe"
                src="music_player.html" 
                allowtransparency="true"
                style="top: 20%; left: 20%; width: 420px; height: 500px; min-width: 380px; min-height: 250px;">
        </iframe>
        
        <!-- NEW: Iframe for the Live2D Wallpaper App window -->
        <iframe id="live2d-wallpaper-frame" 
                class="app-iframe"
                src="live2d_wallpaper.html" 
                allowtransparency="true"
                style="top: 25%; left: 40%; width: 400px; height: 220px; min-width: 350px; min-height: 200px;">
        </iframe>
        
        <div id="context-menu">
            <ul class="context-menu-items">
                <li class="context-menu-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg><span class="menu-text">View</span><svg class="arrow" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 12L10 8L6 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></li>
                <li class="context-menu-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M3 3a1 1 0 000 2h14a1 1 0 100-2H3zM3 8a1 1 0 000 2h14a1 1 0 100-2H3zM3 13a1 1 0 000 2h14a1 1 0 100-2H3z" /></svg><span class="menu-text">Sort by</span><svg class="arrow" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 12L10 8L6 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></li>
                <li id="context-menu-refresh" class="context-menu-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg><span class="menu-text">Refresh</span></li>
                <li class="context-menu-separator"></li>
                <li class="context-menu-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg><span class="menu-text">New</span><svg class="arrow" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 12L10 8L6 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></li>
                <li class="context-menu-separator"></li>
                <li class="context-menu-item" id="context-menu-settings"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg><span class="menu-text">Display settings</span></li>
                <li class="context-menu-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M17.293 3.293A1 1 0 0118 4v12a1 1 0 01-1-1H2a1 1 0 01-1-1V4a1 1 0 011-1h4.586a1 1 0 01.707.293l1.414 1.414a1 1 0 00.707.293h3.172a1 1 0 00.707-.293l1.414-1.414A1 1 0 0112.414 3H17.293zM2 6v10h16V6H2z" /></svg><span class="menu-text">Personalize</span></li>
            </ul>
        </div>

        <canvas id="visualizer"></canvas>

        <div id="taskbar" class="taskbar-bottom">
            <div id="taskbar-main-group" class="flex items-center gap-1">
                <div id="start-button" class="taskbar-icon"><img src="https://img.icons8.com/fluency/48/windows-11.png" alt="Start"/></div>
                <div id="app-icons" class="flex items-center gap-1">
                    <div class="taskbar-icon"><img src="https://syahdafahreza.my.id/images/desktopicons/explorer.png" alt="Folder"/></div>
                    <div class="taskbar-icon"><img src="https://syahdafahreza.my.id/images/desktopicons/msedge2019.png" alt="Edge"/></div>
                    <div class="taskbar-icon"><img src="https://syahdafahreza.my.id/images/desktopicons/winstoreapp-dark.png" alt="Store"/></div>
                    <div id="taskbar-cp-icon" class="taskbar-icon" style="display: none;"><img src="https://img.icons8.com/fluency/48/000000/control-panel.png" alt="Control Panel"/></div>
                    <div id="taskbar-music-icon" class="taskbar-icon" style="display: none;"><img src="https://img.icons8.com/fluency/48/000000/apple-music.png" alt="Music Player"/></div>
                    <!-- NEW: Taskbar icon for Live Wallpaper -->
                    <div id="taskbar-live2d-icon" class="taskbar-icon" style="display: none;"><img src="https://img.icons8.com/fluency/48/domain.png" alt="Live Wallpaper"/></div>
                </div>
            </div>
            <div id="system-tray" class="flex items-center gap-2">
                <div class="taskbar-icon p-2"><svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg></div>
                <div class="taskbar-icon p-2"><svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071a10 10 0 0114.142 0M1.394 9.393a15 15 0 0121.213 0" /></svg></div>
                <div class="text-sm px-1"><span>ENG</span></div>
                <div id="datetime-container" class="text-xs text-right leading-tight px-1 cursor-default"><span id="clock">15:45</span><span id="date" class="block">28/09/2025</span></div>
                <div class="taskbar-icon p-2"><svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
            </div>
        </div>
    </div>

<script>
    // === ALL ELEMENT DECLARATIONS ===
    const desktop = document.getElementById('desktop');
    const wallpaperIframe = document.getElementById('wallpaper-iframe');
    const clickInterceptor = document.getElementById('click-interceptor'); // NEW: Invisible layer
    
    // App Iframes
    const controlPanelIcon = document.getElementById('control-panel-icon');
    const controlPanelFrame = document.getElementById('control-panel-frame');
    const musicPlayerIcon = document.getElementById('music-player-icon');
    const musicPlayerFrame = document.getElementById('music-player-frame');
    const live2dIcon = document.getElementById('live2d-icon');
    const live2dWallpaperFrame = document.getElementById('live2d-wallpaper-frame');

    // Visualizer Elements
    const visualizerCanvas = document.getElementById('visualizer');
    const visualizerCtx = visualizerCanvas.getContext('2d');
    
    // Taskbar Elements
    const taskbar = document.getElementById('taskbar');
    const datetimeContainer = document.getElementById('datetime-container');
    const clockElement = document.getElementById('clock');
    const dateElement = document.getElementById('date');
    const systemTray = document.getElementById('system-tray');
    const taskbarMainGroup = document.getElementById('taskbar-main-group');
    const appIconsContainer = document.getElementById('app-icons');
    const taskbarControlPanelIcon = document.getElementById('taskbar-cp-icon');
    const taskbarMusicIcon = document.getElementById('taskbar-music-icon');
    const taskbarLive2dIcon = document.getElementById('taskbar-live2d-icon');

    // Start Menu Elements
    const startButton = document.getElementById('start-button');
    const startMenuFrame = document.getElementById('start-menu-frame');

    // Context Menu Elements
    const contextMenu = document.getElementById('context-menu');
    const contextMenuSettings = document.getElementById('context-menu-settings');
    const contextMenuRefresh = document.getElementById('context-menu-refresh');

    // Global State Variables
    let isMusicPlayerOpen = false;
    let isControlPanelOpen = false;
    let isLive2dOpen = false;
    let lastMusicPlayerRect = null;
    let lastControlPanelRect = null;
    let lastLive2dRect = null;
    let visualizerData = null;
    let previousBarHeights = [];
    let currentTaskbarPosition = 'bottom';
    let currentTaskbarStyle = 'default';
    let isTaskbarSpaceBetween = false;

    const visualizerSettings = {
        shadowBlur: 4, 
        smoothingFactor: 0.5, bassMultiplier: 0.75, bassEndPercentage: 0.25, midBoostAmount: 0.8,
        trebleStartPercentage: 0.5, trebleBoostAmount: 0.2, scalingPower: 2.0,
        height: 200, width: 120, islandBorderRadius: '12px', islandGap: 6,
    };

    // === CORE FUNCTIONS ===

    function updateClock() {
        const now = new Date();
        clockElement.textContent = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
        dateElement.textContent = `${now.getDate().toString().padStart(2, '0')}/${(now.getMonth() + 1).toString().padStart(2, '0')}/${now.getFullYear()}`;
    }

    function setupWallpaperDragDrop() {
        desktop.addEventListener('dragover', (e) => { e.preventDefault(); desktop.classList.add('drag-over'); });
        desktop.addEventListener('dragleave', () => { desktop.classList.remove('drag-over'); });
        desktop.addEventListener('drop', (e) => {
            e.preventDefault();
            desktop.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (event) => { 
                    // When a new image is dropped, clear the live wallpaper
                    wallpaperIframe.src = 'about:blank';
                    wallpaperIframe.style.display = 'none';
                    clickInterceptor.style.display = 'none'; // NEW: Hide interceptor too
                    desktop.style.backgroundImage = `url('${event.target.result}')`; 
                };
                reader.readAsDataURL(file);
            }
        });
    }

    // --- GENERIC APP IFRAME MANAGEMENT ---
    
    function openApp(appName) {
        let appFrame, taskbarIcon;
        if (appName === 'music') {
            appFrame = musicPlayerFrame;
            taskbarIcon = taskbarMusicIcon;
            if (isMusicPlayerOpen) { bringToFront('music'); return; }
            isMusicPlayerOpen = true;
        } else if (appName === 'cp') {
            appFrame = controlPanelFrame;
            taskbarIcon = taskbarControlPanelIcon;
            if (isControlPanelOpen) { bringToFront('cp'); return; }
            isControlPanelOpen = true;
        } else if (appName === 'live2d') { // NEW
            appFrame = live2dWallpaperFrame;
            taskbarIcon = taskbarLive2dIcon;
            if (isLive2dOpen) { bringToFront('live2d'); return; }
            isLive2dOpen = true;
        }

        taskbarIcon.style.display = 'flex';
        appFrame.style.display = 'block';
        appFrame.style.transition = 'none';
        appFrame.style.transform = 'scale(1)';
        appFrame.style.opacity = '1';
        
        bringToFront(appName);
        
        if (appName === 'music') {
            visualizerCanvas.style.display = 'block';
            drawVisualizer();
        }
    }

    function closeApp(appName) {
        let appFrame, taskbarIcon;
        if (appName === 'music') {
            isMusicPlayerOpen = false;
            appFrame = musicPlayerFrame;
            taskbarIcon = taskbarMusicIcon;
            visualizerCanvas.style.display = 'none';
            visualizerData = null;
            appFrame.contentWindow.postMessage({ action: 'stop' }, '*');
        } else if (appName === 'cp') {
            isControlPanelOpen = false;
            appFrame = controlPanelFrame;
            taskbarIcon = taskbarControlPanelIcon;
        } else if (appName === 'live2d') { // NEW
            isLive2dOpen = false;
            appFrame = live2dWallpaperFrame;
            taskbarIcon = taskbarLive2dIcon;
        }
        appFrame.style.display = 'none';
        taskbarIcon.style.display = 'none';
    }
    
    function minimizeApp(appName) {
        let appFrame, lastRect, taskbarIcon;
        if (appName === 'music') {
            appFrame = musicPlayerFrame;
            taskbarIcon = taskbarMusicIcon;
            lastMusicPlayerRect = appFrame.getBoundingClientRect();
            lastRect = lastMusicPlayerRect;
        } else if (appName === 'cp') {
            appFrame = controlPanelFrame;
            taskbarIcon = taskbarControlPanelIcon;
            lastControlPanelRect = appFrame.getBoundingClientRect();
            lastRect = lastControlPanelRect;
        } else if (appName === 'live2d') { // NEW
            appFrame = live2dWallpaperFrame;
            taskbarIcon = taskbarLive2dIcon;
            lastLive2dRect = appFrame.getBoundingClientRect();
            lastRect = lastLive2dRect;
        }
        
        if (appFrame.style.display === 'none' || appFrame.style.opacity === '0') return;
        
        const targetRect = taskbarIcon.getBoundingClientRect();
        const translateX = targetRect.left - lastRect.left;
        const translateY = targetRect.top - lastRect.top;

        appFrame.style.transition = 'transform 0.3s ease-in, opacity 0.3s ease-in';
        appFrame.style.transformOrigin = 'top left';
        appFrame.style.transform = `translate(${translateX}px, ${translateY}px) scale(0.1)`;
        appFrame.style.opacity = '0';
        
        setTimeout(() => { appFrame.style.display = 'none'; }, 300);
    }

    function restoreApp(appName) {
        let appFrame, lastRect, taskbarIcon;
        if (appName === 'music') {
            appFrame = musicPlayerFrame;
            lastRect = lastMusicPlayerRect;
            taskbarIcon = taskbarMusicIcon;
        } else if (appName === 'cp') {
            appFrame = controlPanelFrame;
            lastRect = lastControlPanelRect;
            taskbarIcon = taskbarControlPanelIcon;
        } else if (appName === 'live2d') { // NEW
            appFrame = live2dWallpaperFrame;
            lastRect = lastLive2dRect;
            taskbarIcon = taskbarLive2dIcon;
        }

        if (!lastRect) return;

        const targetRect = taskbarIcon.getBoundingClientRect();
        const startX = targetRect.left - lastRect.left;
        const startY = targetRect.top - lastRect.top;

        appFrame.style.transition = 'none';
        appFrame.style.transform = `translate(${startX}px, ${startY}px) scale(0.1)`;
        appFrame.style.opacity = '0';
        appFrame.style.display = 'block';
        
        bringToFront(appName);

        setTimeout(() => {
            appFrame.style.transition = 'transform 0.3s ease-out, opacity 0.3s ease-out';
            appFrame.style.transform = 'translate(0, 0) scale(1)';
            appFrame.style.opacity = '1';
        }, 10);
    }

    function bringToFront(appName) {
        const zIndexApp = 1002;
        const zIndexOther = 1001;
        musicPlayerFrame.style.zIndex = zIndexOther;
        controlPanelFrame.style.zIndex = zIndexOther;
        live2dWallpaperFrame.style.zIndex = zIndexOther; // NEW

        if (appName === 'music') {
            musicPlayerFrame.style.zIndex = zIndexApp;
        } else if (appName === 'cp') {
            controlPanelFrame.style.zIndex = zIndexApp;
        } else if (appName === 'live2d') { // NEW
            live2dWallpaperFrame.style.zIndex = zIndexApp;
        }
    }
    
    function setupAppInteractions() {
        controlPanelIcon.addEventListener('dblclick', () => openApp('cp'));
        musicPlayerIcon.addEventListener('dblclick', () => openApp('music'));
        live2dIcon.addEventListener('dblclick', () => openApp('live2d')); // NEW
        
        taskbarControlPanelIcon.addEventListener('click', () => {
            if (!isControlPanelOpen) return;
            (controlPanelFrame.style.opacity === '1' && controlPanelFrame.style.display !== 'none') ? minimizeApp('cp') : restoreApp('cp');
        });
        taskbarMusicIcon.addEventListener('click', () => {
            if (!isMusicPlayerOpen) return;
            (musicPlayerFrame.style.opacity === '1' && musicPlayerFrame.style.display !== 'none') ? minimizeApp('music') : restoreApp('music');
        });
        taskbarLive2dIcon.addEventListener('click', () => { // NEW
            if (!isLive2dOpen) return;
            (live2dWallpaperFrame.style.opacity === '1' && live2dWallpaperFrame.style.display !== 'none') ? minimizeApp('live2d') : restoreApp('live2d');
        });
    }

    // --- VISUALIZER FUNCTIONS ---
    
    function drawVisualizer() {
        requestAnimationFrame(drawVisualizer);
        visualizerCtx.clearRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);
        
        if (!visualizerData || visualizerData.isPaused) {
            if (previousBarHeights.some(h => h > 0.1)) {
                 for(let i=0; i < previousBarHeights.length; i++) { previousBarHeights[i] *= 0.9; }
            } else { return; }
        }
        
        const bufferLength = visualizerData ? visualizerData.bufferLength : previousBarHeights.length;
        if (bufferLength === 0) return;
        while (previousBarHeights.length < bufferLength) previousBarHeights.push(0);

        const computedStyle = getComputedStyle(document.body);
        visualizerCtx.fillStyle = computedStyle.getPropertyValue('--visualizer-fill').trim();
        visualizerCtx.shadowBlur = visualizerSettings.shadowBlur;
        visualizerCtx.shadowColor = computedStyle.getPropertyValue('--visualizer-shadow').trim();
        
        const bassEndIndex = Math.floor(bufferLength * visualizerSettings.bassEndPercentage);
        const trebleStartIndex = Math.floor(bufferLength * visualizerSettings.trebleStartPercentage); 
        
        if (currentTaskbarPosition === 'top' || currentTaskbarPosition === 'bottom') {
            const barWidth = visualizerCanvas.width / bufferLength;
            for(let i = 0; i < bufferLength; i++) {
                let targetHeight = (visualizerData && !visualizerData.isPaused) ? (visualizerData.data[i] / 255) * visualizerCanvas.height : previousBarHeights[i];
                if (visualizerData && !visualizerData.isPaused) {
                    if (i <= bassEndIndex) targetHeight *= visualizerSettings.bassMultiplier;
                    else if (i >= trebleStartIndex) targetHeight *= (1.0 + visualizerSettings.trebleBoostAmount * ((i - trebleStartIndex) / (bufferLength - trebleStartIndex)));
                    else targetHeight *= visualizerSettings.midBoostAmount;
                    targetHeight = Math.pow(targetHeight / visualizerCanvas.height, visualizerSettings.scalingPower) * visualizerCanvas.height;
                }
                const smoothedHeight = (previousBarHeights[i] || 0) + (targetHeight - (previousBarHeights[i] || 0)) * visualizerSettings.smoothingFactor;
                const y = currentTaskbarPosition === 'top' ? 0 : visualizerCanvas.height - smoothedHeight;
                visualizerCtx.fillRect(i * barWidth, y, barWidth, smoothedHeight);
                previousBarHeights[i] = smoothedHeight;
            }
        } else {
            const barHeight = visualizerCanvas.height / bufferLength;
            for(let i = 0; i < bufferLength; i++) {
                 let targetWidth = (visualizerData && !visualizerData.isPaused) ? (visualizerData.data[i] / 255) * visualizerCanvas.width : previousBarHeights[i];
                if (visualizerData && !visualizerData.isPaused) {
                    if (i <= bassEndIndex) targetWidth *= visualizerSettings.bassMultiplier;
                    else if (i >= trebleStartIndex) targetWidth *= (1.0 + visualizerSettings.trebleBoostAmount * ((i - trebleStartIndex) / (bufferLength - trebleStartIndex)));
                    else targetWidth *= visualizerSettings.midBoostAmount;
                    targetWidth = Math.pow(targetWidth / visualizerCanvas.width, visualizerSettings.scalingPower) * visualizerCanvas.width;
                }
                const smoothedWidth = (previousBarHeights[i] || 0) + (targetWidth - (previousBarHeights[i] || 0)) * visualizerSettings.smoothingFactor;
                const x = currentTaskbarPosition === 'left' ? 0 : visualizerCanvas.width - smoothedWidth;
                visualizerCtx.fillRect(x, i * barHeight, smoothedWidth, barHeight);
                previousBarHeights[i] = smoothedWidth;
            }
        }
    }

    function positionVisualizer() {
        const isIsland = currentTaskbarStyle.startsWith('island');
        const isSpecialCenterCase = (currentTaskbarStyle === 'island-single' && !isTaskbarSpaceBetween);
        
        if (isIsland) {
            visualizerCanvas.style.borderRadius = visualizerSettings.islandBorderRadius;
        } else {
            visualizerCanvas.style.borderRadius = '0';
        }
        
        ['top', 'bottom', 'left', 'right'].forEach(p => visualizerCanvas.style[p] = 'auto');
        
        if (isSpecialCenterCase && (currentTaskbarPosition === 'top' || currentTaskbarPosition === 'bottom')) {
            const rect = taskbar.getBoundingClientRect();
            const vizWidth = 500;
            visualizerCanvas.width = vizWidth;
            visualizerCanvas.height = visualizerSettings.height;
            visualizerCanvas.style.width = vizWidth + 'px';
            visualizerCanvas.style.height = visualizerSettings.height + 'px';
            visualizerCanvas.style.left = `calc(50% - ${vizWidth / 2}px)`;
            if (currentTaskbarPosition === 'top') {
                visualizerCanvas.style.top = (rect.bottom + visualizerSettings.islandGap) + 'px';
            } else {
                visualizerCanvas.style.top = (rect.top - visualizerSettings.height - visualizerSettings.islandGap) + 'px';
            }
        } else {
            const rect = taskbar.getBoundingClientRect();
            if (currentTaskbarPosition === 'top' || currentTaskbarPosition === 'bottom') {
                visualizerCanvas.width = rect.width;
                visualizerCanvas.height = visualizerSettings.height;
                visualizerCanvas.style.width = rect.width + 'px';
                visualizerCanvas.style.height = visualizerSettings.height + 'px';
                visualizerCanvas.style.left = rect.left + 'px';
                if (currentTaskbarPosition === 'top') {
                    visualizerCanvas.style.top = (isIsland ? rect.bottom + visualizerSettings.islandGap : rect.bottom) + 'px';
                } else {
                    visualizerCanvas.style.top = (isIsland ? (rect.top - visualizerSettings.height - visualizerSettings.islandGap) : (rect.top - visualizerSettings.height)) + 'px';
                }
            } else {
                visualizerCanvas.width = visualizerSettings.width;
                visualizerCanvas.height = rect.height;
                visualizerCanvas.style.width = visualizerSettings.width + 'px';
                visualizerCanvas.style.height = rect.height + 'px';
                visualizerCanvas.style.top = rect.top + 'px';
                if (currentTaskbarPosition === 'left') {
                    visualizerCanvas.style.left = (isIsland ? rect.right + visualizerSettings.islandGap : rect.right) + 'px';
                } else {
                    visualizerCanvas.style.left = (isIsland ? (rect.left - visualizerSettings.width - visualizerSettings.islandGap) : (rect.left - visualizerSettings.width)) + 'px';
                }
            }
        }
    }
    
    // --- TASKBAR & LAYOUT FUNCTIONS ---
    function applyTaskbarLayout(position) {
        currentTaskbarPosition = position;
        const isVertical = position === 'left' || position === 'right';
        taskbarMainGroup.classList.toggle('flex-col', isVertical);
        appIconsContainer.classList.toggle('flex-col', isVertical);
        systemTray.classList.toggle('flex-col', isVertical);
        positionVisualizer();
    }
    
    function applyTaskbarStyle(style) {
        currentTaskbarStyle = style;
        taskbar.classList.remove('island', 'single', 'split', 'space-between');
        if (style === 'default') { taskbar.style.transform = ''; taskbar.style.left = ''; taskbar.style.right = ''; taskbar.style.width = ''; }
        if (style === 'island-single') taskbar.classList.add('island', 'single');
        if (style === 'island-split') taskbar.classList.add('island', 'split');
        if (isTaskbarSpaceBetween && style.startsWith('island')) taskbar.classList.add('space-between');
        setTimeout(positionVisualizer, 50);
    }

    // --- CONTEXT MENU FUNCTION ---
    // NEW: Reusable function to show the context menu at a specific event's coordinates.
    function showDesktopContextMenu(e) {
        startMenuFrame.classList.remove('show');
        contextMenu.style.display = 'block';
        const { clientX: mouseX, clientY: mouseY } = e;
        const { offsetWidth: menuWidth, offsetHeight: menuHeight } = contextMenu;
        const { innerWidth: windowWidth, innerHeight: windowHeight } = window;
        let x = (mouseX + menuWidth > windowWidth) ? windowWidth - menuWidth - 5 : mouseX;
        let y = (mouseY + menuHeight > windowHeight) ? windowHeight - menuHeight - 5 : mouseY;
        contextMenu.style.top = `${y}px`; contextMenu.style.left = `${x}px`;
    }

    // --- MENU FUNCTIONS ---
    
    function positionMenuRelativeToButton(menuElement, buttonElement) {
        const buttonRect = buttonElement.getBoundingClientRect();
        const menuRect = menuElement.getBoundingClientRect();
        const taskbarRect = taskbar.getBoundingClientRect();
        const gap = 4;

        let top, left, bottom;

        menuElement.style.setProperty('--start-menu-top', 'auto');
        menuElement.style.setProperty('--start-menu-bottom', 'auto');

        switch (currentTaskbarPosition) {
            case 'top':
                top = taskbarRect.bottom + gap;
                left = buttonRect.left;
                menuElement.style.transformOrigin = 'top left';
                break;
            case 'left':
                top = buttonRect.top;
                left = taskbarRect.right + gap;
                menuElement.style.transformOrigin = 'center left';
                break;
            case 'right':
                top = buttonRect.top;
                left = taskbarRect.left - menuRect.width - gap;
                menuElement.style.transformOrigin = 'center right';
                break;
            case 'bottom':
            default:
                const isFullscreen = (screen.height - window.innerHeight) < 100;
                const offset = isFullscreen ? -88 : -24; 
                
                bottom = (window.innerHeight - taskbarRect.top) + gap + offset;
                left = buttonRect.left;
                menuElement.style.transformOrigin = 'bottom left';
                break;
        }
        
        if (left < gap) {
            left = gap;
        } else if (left + menuRect.width > window.innerWidth - gap) {
            left = window.innerWidth - menuRect.width - gap;
        }
        menuElement.style.setProperty('--start-menu-left', `${left}px`);

        if (top !== undefined) {
            menuElement.style.setProperty('--start-menu-top', `${top}px`);
            setTimeout(() => {
                const finalMenuRect = menuElement.getBoundingClientRect();
                if (finalMenuRect.bottom > window.innerHeight - gap) {
                    menuElement.style.setProperty('--start-menu-top', 'auto');
                    menuElement.style.setProperty('--start-menu-bottom', `${gap}px`);
                }
            }, 0);
        }
        
        if (bottom !== undefined) {
            menuElement.style.setProperty('--start-menu-bottom', `${bottom}px`);
            setTimeout(() => {
                const finalMenuRect = menuElement.getBoundingClientRect();
                if (finalMenuRect.top < gap) {
                    menuElement.style.setProperty('--start-menu-bottom', 'auto');
                    menuElement.style.setProperty('--start-menu-top', `${gap}px`);
                }
            }, 0);
        }
    }

    function positionStartMenu() {
        positionMenuRelativeToButton(startMenuFrame, startButton);
    }
    
    function setupMenus() {
        startButton.addEventListener('click', (event) => {
            event.stopPropagation();
            const isShowing = startMenuFrame.classList.contains('show');
            
            startMenuFrame.classList.toggle('show');

            if (!isShowing) {
                positionStartMenu();
            }
        });

        // MODIFIED: Use the new reusable function
        desktop.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            showDesktopContextMenu(e);
        });

        // NEW: Add a context menu listener to the interceptor layer.
        // This ensures the desktop context menu appears even when right-clicking on the live wallpaper.
        clickInterceptor.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            showDesktopContextMenu(e);
        });

        document.addEventListener('click', (e) => {
            if (contextMenu.style.display === 'block' && !contextMenu.contains(e.target)) {
                contextMenu.style.display = 'none';
            }
            if (startMenuFrame.classList.contains('show') && !e.composedPath().includes(startMenuFrame) && !startButton.contains(e.target)) {
                 startMenuFrame.classList.remove('show');
            }
        });
        
        contextMenuSettings.addEventListener('click', () => {
            openApp('cp');
            contextMenu.style.display = 'none';
        });

        contextMenuRefresh.addEventListener('click', () => {
            contextMenu.style.display = 'none';

            const icons = Array.from(document.querySelectorAll('#desktop-icons .desktop-icon'));
            const animationDelay = 150;

            icons.forEach(icon => {
                icon.classList.remove('animate-in');
                icon.classList.add('hide-for-refresh');
            });

            setTimeout(() => {
                icons.forEach((icon, index) => {
                    setTimeout(() => {
                        icon.classList.remove('hide-for-refresh');
                        icon.classList.add('animate-in');
                    }, index * animationDelay);
                });
            }, 50);
        });
    }

    // NEW: Function to handle forwarding clicks to the live wallpaper iframe
    function setupClickForwarding() {
        // When the mouse button is pressed down on the interceptor layer
        clickInterceptor.addEventListener('mousedown', (e) => {
            // If it's a left click, make the interceptor layer temporarily "transparent" to mouse events,
            // allowing the click event to pass through to the iframe below.
            if (e.button === 0) { // 0 is the main button, usually left
                clickInterceptor.style.pointerEvents = 'none';
            }
        });

        // When the mouse button is released anywhere in the window
        window.addEventListener('mouseup', (e) => {
            // If the interceptor was made transparent, make it solid again to catch the next click.
            if (clickInterceptor.style.pointerEvents === 'none') {
                clickInterceptor.style.pointerEvents = 'auto';
            }
        });
    }

    // === APPLICATION INITIALIZATION ===
    function initialize() {
        setupWallpaperDragDrop();
        setupAppInteractions();
        setupMenus();
        setupClickForwarding(); // NEW: Initialize the click forwarding logic
        
        window.addEventListener('message', (event) => {
            const { action, dx, dy, data, bufferLength, isPaused, value, appName } = event.data;

            switch(action) {
                // Music Player
                case 'drag-music-frame': { const rect = musicPlayerFrame.getBoundingClientRect(); musicPlayerFrame.style.left = `${rect.left + dx}px`; musicPlayerFrame.style.top = `${rect.top + dy}px`; break; }
                case 'close-music-frame': closeApp('music'); break;
                case 'minimize-music-frame': minimizeApp('music'); break;
                case 'bring-music-to-front': bringToFront('music'); break;
                case 'visualizer-data': visualizerData = { data: data, bufferLength: bufferLength, isPaused: isPaused }; break;
                
                // Control Panel
                case 'drag-cp-frame': { const rect = controlPanelFrame.getBoundingClientRect(); controlPanelFrame.style.left = `${rect.left + dx}px`; controlPanelFrame.style.top = `${rect.top + dy}px`; break; }
                case 'close-cp-frame': closeApp('cp'); break;
                case 'minimize-cp-frame': minimizeApp('cp'); break;
                case 'bring-cp-to-front': bringToFront('cp'); break;

                // Live2D Wallpaper (NEW)
                case 'drag-live2d-frame': { const rect = live2dWallpaperFrame.getBoundingClientRect(); live2dWallpaperFrame.style.left = `${rect.left + dx}px`; live2dWallpaperFrame.style.top = `${rect.top + dy}px`; break; }
                case 'close-live2d-frame': closeApp('live2d'); break;
                case 'minimize-live2d-frame': minimizeApp('live2d'); break;
                case 'bring-live2d-to-front': bringToFront('live2d'); break;
                case 'set-live-wallpaper':
                    wallpaperIframe.src = value;
                    wallpaperIframe.style.display = 'block';
                    clickInterceptor.style.display = 'block'; // Show the interceptor layer
                    desktop.style.backgroundImage = 'none';
                    break;
                case 'clear-live-wallpaper':
                    wallpaperIframe.src = 'about:blank';
                    wallpaperIframe.style.display = 'none';
                    clickInterceptor.style.display = 'none'; // Hide the interceptor layer
                    // Fallback to default or previously set background image
                    if (desktop.style.backgroundImage === 'none') {
                        desktop.style.backgroundImage = ''; // Let CSS take over
                    }
                    break;

                // Start Menu -> Desktop
                case 'open-app-from-start-menu': 
                    openApp(appName); 
                    startMenuFrame.classList.remove('show'); 
                    break;

                // Control Panel -> Desktop (Broadcast/Settings)
                case 'toggle-fancy-mode':
                    document.body.classList.toggle('fancy-mode', value);
                    musicPlayerFrame.contentWindow.postMessage({ action: 'toggle-fancy-mode', value: value }, '*');
                    controlPanelFrame.contentWindow.postMessage({ action: 'toggle-fancy-mode', value: value }, '*');
                    startMenuFrame.contentWindow.postMessage({ action: 'toggle-fancy-mode', value: value }, '*');
                    live2dWallpaperFrame.contentWindow.postMessage({ action: 'toggle-fancy-mode', value: value }, '*'); // NEW
                    break;
                case 'request-settings':
                    controlPanelFrame.contentWindow.postMessage({ action: 'request-settings' }, '*');
                    break;
                case 'change-theme': {
                    const isDark = value === 'dark';
                    document.body.classList.toggle('dark', isDark);
                    musicPlayerFrame.contentWindow.postMessage({ action: 'theme-change', isDark }, '*');
                    controlPanelFrame.contentWindow.postMessage({ action: 'theme-change', isDark }, '*');
                    startMenuFrame.contentWindow.postMessage({ action: 'theme-change', isDark }, '*');
                    live2dWallpaperFrame.contentWindow.postMessage({ action: 'theme-change', isDark }, '*'); // NEW
                    break;
                }
                case 'change-bg-size': desktop.style.backgroundSize = value; break;
                case 'change-bg-repeat': desktop.style.backgroundRepeat = value; break;
                case 'change-bg-position': desktop.style.backgroundPosition = value; break;
                case 'change-taskbar-position': 
                    taskbar.className = taskbar.className.replace(/taskbar-(bottom|top|left|right)/, `taskbar-${value}`);
                    applyTaskbarLayout(value);
                    if (startMenuFrame.classList.contains('show')) {
                        positionStartMenu();
                    }
                    break;
                case 'change-taskbar-style':
                    applyTaskbarStyle(value);
                    if (startMenuFrame.classList.contains('show')) {
                        positionStartMenu();
                    }
                    break;
                case 'toggle-taskbar-space-between':
                    isTaskbarSpaceBetween = value;
                    taskbar.classList.toggle('space-between', value);
                    setTimeout(positionVisualizer, 50);
                    break;
                case 'toggle-clock':
                    datetimeContainer.style.display = value ? 'block' : 'none';
                    break;
            }
        });
        
        setInterval(updateClock, 1000);
        updateClock();

        window.addEventListener('load', () => {
            applyTaskbarLayout(currentTaskbarPosition);
            window.addEventListener('resize', () => {
                setTimeout(positionVisualizer, 50);
                if (startMenuFrame.classList.contains('show')) {
                    positionStartMenu();
                }
            });
            window.addEventListener('scroll', () => {
                 if (startMenuFrame.classList.contains('show')) {
                    positionStartMenu();
                }
            }, true);

            setTimeout(() => { window.dispatchEvent(new Event('resize')); }, 350);
        });
    }

    initialize();
</script>
</body>
</html>